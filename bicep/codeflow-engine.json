{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "14111739180302895686"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "prod",
      "metadata": {
        "description": "Environment name (prod, dev, staging)"
      }
    },
    "regionAbbr": {
      "type": "string",
      "defaultValue": "san",
      "metadata": {
        "description": "Azure region abbreviation (eus, wus, san, etc.)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus2",
      "metadata": {
        "description": "Azure region full name for most resources"
      }
    },
    "postgresLocation": {
      "type": "string",
      "defaultValue": "southafricanorth",
      "metadata": {
        "description": "PostgreSQL region (must support Flexible Server and be available in your subscription)"
      }
    },
    "containerImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Container image name. Must be publicly accessible or use registry credentials. Build and push the image first using the GitHub Actions workflow. Default is a placeholder for testing."
      }
    },
    "postgresLogin": {
      "type": "string",
      "defaultValue": "autopr",
      "metadata": {
        "description": "PostgreSQL administrator login username"
      }
    },
    "postgresPassword": {
      "type": "securestring",
      "metadata": {
        "description": "PostgreSQL administrator password"
      }
    },
    "redisPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Redis password"
      }
    },
    "customDomain": {
      "type": "string",
      "defaultValue": "app.autopr.io",
      "metadata": {
        "description": "Custom domain name for the container app"
      }
    }
  },
  "variables": {
    "resourceNamePrefix": "[format('{0}-autopr-{1}', parameters('environment'), parameters('regionAbbr'))]",
    "containerAppName": "[format('{0}-app', variables('resourceNamePrefix'))]",
    "containerAppEnvName": "[format('{0}-env', variables('resourceNamePrefix'))]",
    "postgresServerName": "[format('{0}-postgres-{1}', variables('resourceNamePrefix'), uniqueString(resourceGroup().id, parameters('postgresLocation')))]",
    "redisCacheName": "[format('{0}-redis', variables('resourceNamePrefix'))]",
    "logAnalyticsWorkspaceName": "[format('{0}-logs', variables('resourceNamePrefix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsWorkspaceName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2024-10-02-preview",
      "name": "[variables('containerAppEnvName')]",
      "location": "[parameters('location')]",
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), '2022-10-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), '2022-10-01').primarySharedKey]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
      ]
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2023-06-01-preview",
      "name": "[variables('postgresServerName')]",
      "location": "[parameters('postgresLocation')]",
      "sku": {
        "name": "Standard_B1ms",
        "tier": "Burstable"
      },
      "properties": {
        "administratorLogin": "[parameters('postgresLogin')]",
        "administratorLoginPassword": "[parameters('postgresPassword')]",
        "version": "15",
        "storage": {
          "storageSizeGB": 32
        },
        "backup": {
          "backupRetentionDays": 7,
          "geoRedundantBackup": "Disabled"
        },
        "highAvailability": {
          "mode": "Disabled"
        }
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
      "apiVersion": "2023-06-01-preview",
      "name": "[format('{0}/{1}', variables('postgresServerName'), 'autopr')]",
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
      ]
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
      "apiVersion": "2023-06-01-preview",
      "name": "[format('{0}/{1}', variables('postgresServerName'), 'AllowAzureServices')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
      ]
    },
    {
      "type": "Microsoft.Cache/redis",
      "apiVersion": "2023-08-01",
      "name": "[variables('redisCacheName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "name": "Basic",
          "family": "C",
          "capacity": 1
        },
        "enableNonSslPort": false,
        "minimumTlsVersion": "1.2"
      }
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-10-02-preview",
      "name": "[variables('containerAppName')]",
      "location": "[parameters('location')]",
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]",
        "configuration": {
          "ingress": {
            "external": true,
            "targetPort": 8080,
            "allowInsecure": false,
            "transport": "auto",
            "customDomains": [
              {
                "name": "[parameters('customDomain')]",
                "bindingType": "Auto"
              }
            ]
          },
          "secrets": [
            {
              "name": "postgres-password",
              "value": "[parameters('postgresPassword')]"
            },
            {
              "name": "redis-password",
              "value": "[parameters('redisPassword')]"
            }
          ]
        },
        "template": {
          "containers": [
            {
              "name": "autopr-engine",
              "image": "[parameters('containerImage')]",
              "env": [
                {
                  "name": "AUTOPR_ENV",
                  "value": "[parameters('environment')]"
                },
                {
                  "name": "HOST",
                  "value": "0.0.0.0"
                },
                {
                  "name": "PORT",
                  "value": "8080"
                },
                {
                  "name": "POSTGRES_HOST",
                  "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName')), '2023-06-01-preview').fullyQualifiedDomainName]"
                },
                {
                  "name": "POSTGRES_PORT",
                  "value": "5432"
                },
                {
                  "name": "POSTGRES_DB",
                  "value": "autopr"
                },
                {
                  "name": "POSTGRES_USER",
                  "value": "[parameters('postgresLogin')]"
                },
                {
                  "name": "POSTGRES_PASSWORD",
                  "secretRef": "postgres-password"
                },
                {
                  "name": "POSTGRES_SSLMODE",
                  "value": "require"
                },
                {
                  "name": "REDIS_HOST",
                  "value": "[reference(resourceId('Microsoft.Cache/redis', variables('redisCacheName')), '2023-08-01').hostName]"
                },
                {
                  "name": "REDIS_PORT",
                  "value": "6380"
                },
                {
                  "name": "REDIS_PASSWORD",
                  "secretRef": "redis-password"
                },
                {
                  "name": "REDIS_SSL",
                  "value": "true"
                }
              ],
              "resources": {
                "cpu": "[json('1.0')]",
                "memory": "2Gi"
              }
            }
          ],
          "scale": {
            "minReplicas": 1,
            "maxReplicas": 10,
            "rules": [
              {
                "name": "http-rule",
                "http": {
                  "metadata": {
                    "concurrentRequests": "100"
                  }
                }
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]",
        "[resourceId('Microsoft.Cache/redis', variables('redisCacheName'))]"
      ]
    },
    {
      "type": "Microsoft.App/managedEnvironments/managedCertificates",
      "apiVersion": "2024-10-02-preview",
      "name": "[format('{0}/{1}', variables('containerAppEnvName'), format('cert-{0}', replace(parameters('customDomain'), '.', '-')))]",
      "location": "[parameters('location')]",
      "properties": {
        "subjectName": "[parameters('customDomain')]",
        "domainControlValidation": "CNAME"
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', variables('containerAppName'))]",
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]"
      ]
    }
  ],
  "outputs": {
    "containerAppName": {
      "type": "string",
      "value": "[variables('containerAppName')]"
    },
    "containerAppUrl": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2024-10-02-preview').configuration.ingress.fqdn)]"
    },
    "customDomain": {
      "type": "string",
      "value": "[parameters('customDomain')]"
    },
    "postgresServerName": {
      "type": "string",
      "value": "[variables('postgresServerName')]"
    },
    "postgresFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName')), '2023-06-01-preview').fullyQualifiedDomainName]"
    },
    "redisCacheName": {
      "type": "string",
      "value": "[variables('redisCacheName')]"
    },
    "redisHostName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Cache/redis', variables('redisCacheName')), '2023-08-01').hostName]"
    }
  }
}